# TODO: Add code coverage badge to README
# TODO: Add linting/formatting check (JuliaFormatter)
# TODO: Add docstring coverage check
# TODO: Add performance regression detection (BenchmarkCI)
# TODO: Add GPU CI job (CUDA/Reactant runners)
# TODO: Add macOS and Windows test matrix
# TODO: Test with Julia 1.10 for broader compatibility
name: CI
on:
  push:
    branches:
      - main
    tags: ['*']
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}
jobs:
  test:
    name: Julia ${{ matrix.version }} - ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      actions: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.11'
        os:
          - ubuntu-latest
        arch:
          - x64
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      - uses: julia-actions/cache@v2
      - uses: julia-actions/julia-buildpkg@v1
      - uses: julia-actions/julia-runtest@v1
      - uses: julia-actions/julia-processcoverage@v1
      - uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write
      statuses: write
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
      - uses: julia-actions/cache@v2
      - name: Install Julia dependencies
        run: |
          julia --project=docs -e '
            using Pkg
            Pkg.develop(PackageSpec(path=pwd()))
            Pkg.instantiate()'
      - name: Build documentation (markdown only)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: julia --project=docs docs/make.jl
      - name: Install npm dependencies
        working-directory: docs
        run: |
          npm install
          npm install @rollup/rollup-linux-x64-gnu --save-optional
      - name: Fix DocumenterVitepress issues
        run: |
          # Fix YAML frontmatter corruption (nested YAML gets flattened)
          cp docs/src/index.md docs/build/.documenter/index.md
          # Create placeholder JS files to prevent 404s
          echo 'var defined_versions = [];' > docs/build/.documenter/versions.js
          echo 'var defined_versions = [];' > docs/build/versions.js
          echo 'var defined_site = {};' > docs/build/.documenter/siteinfo.js
          # Fix dead links from unresolved @ref in docstrings
          sed -i "s/cleanUrls: true,/cleanUrls: true,\\n  ignoreDeadLinks: ['\\.\\/@ref'],/" docs/build/.documenter/.vitepress/config.mts
      - name: Build VitePress site
        working-directory: docs
        run: npm run docs:build
      - name: Fix folder structure
        run: |
          cd docs/build
          # Rename version folder to match base URL path
          if [ -d "1" ]; then mv 1 dev; fi
          # Create root redirect
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="refresh" content="0; URL=./dev/"><link rel="canonical" href="./dev/"></head><body><p>Redirecting to <a href="./dev/">documentation</a>...</p></body></html>' > index.html
      - name: Deploy to GitHub Pages
        if: github.event_name != 'pull_request'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/build
          force_orphan: true
